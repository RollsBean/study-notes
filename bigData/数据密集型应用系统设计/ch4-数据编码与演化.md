# 第四章-数据编码与演化

## 数据编码格式

数据编码分为两类：

1. 在内存中，数据保存在对象、结构体、列表、树等结构中。
2. 数据写入文件或通过网络发送时，必须将其进行编码。

### 语言特定格式

很多语言内置了序列化方法（编码）。它们的一些问题：

* 编码通常和语言绑定在一起，跨语言访问比较难。
* 编码效率
* 多版本的支持
* 安全问题，它们可以被反序列化为任意类。

### JSON、XML 与二进制变体

#### 二进制编码

支持 JSON 的二进制编码（MessagePack、BSON）占用空间更小。MessagePack 的第一个字节记录 JSON 字段数量，使用一个字节记录 JSON 字段长度，然后是它的具体内容。

### Thrift 与 Protocol Buffers

Thrift、Protocol Buffers 是原理相同的两个二进制编码库。Apache Thrift 需要使用模式来编码任意数据。首先，定义好类来描述模式，然后代码生成工具会生成支持各种语言的类。
应用程序在使用时只需要调用生成的代码来编解码数据。

Thrift 模式类示例：
```text
struct Person {
    1: required string userName,
    2: optional i64 favoriteNumber
    3: optional list<string> interests
}
```

Thrift 有两种二进制编码格式，分别是 BinaryProtocol 和 CompactProtocol。BinaryProtocol 的字节排列：第一个字节代表类型，第二个和第三个字节代表
字段的序号，再往后还是字段值的长度，然后是值。

#### Avro

Apache Avro 是另一种二进制编码格式。Avro 用于适配 Hadoop 而创建的，它也是使用模式来指定编码。它有两种模式语言：一种（IDL）用于人工编辑，另一种
（基于 JSON）更易于机器读取。

#### 模式的优点

* 编码更紧凑，可以省略字段名。
* 向前向后兼容性。

## 数据流模式

进程间数据流动的方式：

* 通过数据库
* 通过服务调用
* 通过异步消息传递

### 基于数据库的数据流

数据库通常需要向前兼容。

### 基于服务的数据流：REST 和 RPC

#### 网络服务

Web 服务主要有两种：REST 和 SOAP。REST 不是协议而是一种基于 HTTP 原则的设计理念。它使用 URL 来标识资源，并使用 HTTP 进行缓存控制、身份验证等。
SOAP 是基于 XML 的协议，SOAP 信息通常过于复杂，已经不太流行来。

#### 远程过程调用（RPC）的问题

RPC 模型试图使向远程网络服务发出请求看起来与在同一进程中方法调用相同。虽然看起来方便，但它也有缺陷：

* 本地函数调用可预测，网络请求不可预测，可能会遇到网络问题，所以需要对这些异常有处理，比如失败重试。
* 网络请求可能会超时，由于超时，它可能没有返回结果。
* 网络请求幂等问题。可能请求失败了，但是请求已经发生了。
* 网络请求需要经过网络，所以比本地请求更慢、更不稳定。
* 本地函数调用可以传递指针，RPC 服务需要发送网络请求并传输数据。
* 客户端和服务端都需要适配某种 RPC 协议才可以进行数据传输。

#### RPC 的发展方向

新的 RPC 更加明确了远程请求和本地函数调用不同的事实。例如使用 Future 来封装异步请求。gRPC 支持流，调用包含来一段时间内一系列的请求和响应。

### 基于消息传递的数据流

本节介绍异步消息传递系统，如消息队列等。

#### 消息代理

一般，消息代理的使用方法如下：一个进程向指定的队列或主题发送消息，代理将消息传递给队列或主题的一个或多个消费者。

#### 分布式 Actor 框架

Actor 模型是用于单个进程中并发的编程模型。每个 Actor 通常代表一个客户端或实体，通过发送和接收异步消息与其他 Actor 通信。不保证消息传送。
